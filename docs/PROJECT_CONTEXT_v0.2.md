# Project Context (v0.2)

项目处理的数据为共聚焦反射模式（reflectance）下银染髓鞘的 Z-stack 显微图像，目标是在强衰减、层间强度不一致与伪影干扰下，稳定预测线状髓鞘并由 2D 结果重建 3D 结构用于长度/方向/密度等定量分析。

## 1. 项目目标与范围

### 总体目标

针对银染 confocal reflectance Z-stack（约 500 个 stack，推理规模），构建可复现的 CV/DL 工作流，实现：

- 2D 层面髓鞘线状结构分割（mask）为主，后续扩展到 2D centerline。
- 2D/2.5D 预测结果的跨层融合与 3D 重建（结构段、方向分布、长度/密度统计）。
- 对 Z 向信号衰减、浅层遮挡深层、两类伪影（染色伪影/散射噪声）具备鲁棒性。

### 不在范围（当前阶段）

- 不做基于强度的生物学定量（允许对图像做较强强度变换）；强度仅作为分割线索而非分析指标。

## 2. 数据与文件特性

### 2.1 数据规模与格式

- 推理规模：约 500 个 Z-stacks。
- 文件格式：统一转换为 OME-TIFF。
- 位深：uint8（8-bit）。
- 体素尺寸（um）：
  - dx = 0.439294
  - dy = 0.439294
  - dz = 0.396329
  - dz/dx ≈ 0.90（Z 采样略密于 XY，近似各向同性；但光学 PSF 仍可能显著各向异性，需在分析中区分“采样各向异性”和“成像分辨各向异性”。）

### 2.2 标注现状

- 现有标注：2D mask（可在 Z 维堆叠形成“伪 3D mask”）。
- 已完整标注数据：约 4 个 Z-stack，~100 张 slice（数量级）。
- 计划增强：从 2D mask 提取 2D centerline；结合“nonsupervised/半监督”扩大有效标注量。

风险提示：把 2D mask 简单堆叠成 3D GT 会引入“跨层一致性假设”，但 GT 本身并未约束跨层连通；评估 3D 重建时容易出现“模型把跨层连起来了，但其实 GT 没表达是否应连”的可解释性问题。需要单独设计 3D 评价策略（见第 5 节）。

### 2.3 计算环境约束（当前主力）

- GPU：实验室主机 RTX 3080（显存容量未明确；通常 10GB/12GB 两种，需要确认）。
- CPU：13th Gen Intel i5-13600K（14 cores / 20 threads）。
- 内存：15 GiB（≈16GB 级别）。

结论：训练与推理需走 patch-based、流式 IO、避免加载整 stack 进内存；大规模推理更需要批处理与断点续跑机制。

## 3. 已知成像/数据问题与影响机制（按“可观测性→学习难点→误差类型”拆解）

### 3.1 Z 向信号衰减 + 层间强度不一致（主要域偏移）

- 现象：衰减主要随 Z 变化；各层强度分布不可比。
- 影响：深层更易漏检（Recall 下降），并诱发“假断裂”（与 Ranvier 结点的真实 gap 难区分）。
- 可控性：允许强度变换，有利于系统性做深度补偿/归一化。

### 3.2 浅层遮挡深层（reflectance 固有可观测性限制）

- 现象：浅层结构可能遮挡深层结构成像（shadowing/遮挡）。
- 影响：深层结构在原始数据中可能“根本不可见”，这不是分割模型能凭空恢复的；模型最多学会“保守缺失”或“统计式补全”（后者会损害定量可信度）。
- 风险：若后续定量要用于生物学结论，必须明确哪些深层缺失是“不可观测”而非“模型失败”。

### 3.3 两类伪影/噪声

- 染色伪影：点状/片状噪音（可能被误判为短线段或节点）。
- 无信号区域的散射噪声：类似颗粒/纹理背景，可能造成伪阳性。
- 影响：假阳性、错误连接（噪声桥接）、骨架化后产生大量短枝。

### 3.4 Ranvier 结点的“断/连”定义不稳定

当前规则倾向：gap 足够短且方向不明显偏折，可视为同一根；最终取决于训练/预测效果。

逻辑风险（需要钉死）：如果“断/连规则”随模型效果调整，会导致评估目标漂移，最终变成“为了指标改定义”。建议：在文档中明确至少两种评价协议并行（见第 5 节），用数据驱动决定主协议，但不在评估后反复改口径。

## 4. 探索方向（阶段性优先级）

### 4.1 阶段 I：2D 与 2.5D（邻层输入）作为主线

动机：标注是 2D mask；3080+16GB 更适合 2D/2.5D 快速迭代；2.5D 能引入最关键的“跨层提示”但成本较低。

实现要点：
- 2D：单 slice 输入 -> mask 概率图。
- 2.5D：输入 [z-k, …, z, …, z+k] 作为多通道（k 可从 1 开始），输出中心 slice 的 mask。
- 训练增强需覆盖：深度衰减模拟、对比度波动、噪声注入、点状/片状伪影合成（尽可能贴近两类噪声机制）。

### 4.2 阶段 II：2D 输出到 3D 重建（终端目标）

核心思想：把“分割”和“重建”拆开，避免把拓扑错误归因不清。

- 输入：逐层概率图/二值 mask/centerline。
- 输出：3D 中心线或 graph（段、端点、方向向量、长度、曲率、断点位置）。
- 关键开关：gap 桥接策略
  - 协议 A（允许 Ranvier 短 gap）：在方向一致且 gap <= 阈值时桥接。
  - 协议 B（保守不断桥）：gap 保持断开。

两套协议都跑，指标分别汇报，避免“口径争议”阻碍结论。

### 4.3 阶段 III：3D 模型（可选，取决于阶段 I/II 瓶颈）

前提：明确 2D/2.5D 的失败模式是否主要来自“Z 向结构不可见/遮挡”还是“模型缺少 3D 上下文”。

- 如果瓶颈是跨层拓扑：考虑 3D U-Net/3D affinity 等。
- 如果瓶颈是遮挡导致不可观测：3D 模型也无法根治，应转向“可观测性标注/不确定性估计/保守定量”。

### 4.4 低标注条件下的扩展策略（与阶段 I 并行）

由于标注仅 4 stacks，强烈建议将 500 stacks 纳入无监督/半监督体系，否则模型极易过拟合“少数样本风格”。

- 自监督预训练（对比学习/掩码重建）-> 少量标注微调。
- 伪标签迭代（高置信区域扩标）。
- 主动学习（挑选最不确定/最能提升泛化的 slice 让人标注）。

## 5. 评估思路（强调“线状结构 + 3D 连通”而非只看 Dice）

### 5.1 数据切分原则（避免泄漏）

- 切分单位应为 stack 级（甚至 animal 级/批次级），禁止按 slice 随机切分。
- 若 500 stacks 来自多个批次/实验日/不同组织区域：建议单独设置“跨批次测试集”。

### 5.2 指标分层（草案）

- 2D 像素级：Dice/IoU、Precision/Recall（尤其关注深层 Recall）。
- 线状结构级：clDice 思想（中心线一致性）、fragmentation（连通分量数、平均段长、最长段长）。
- 3D 重建级：跨层追踪成功率、方向分布偏差、深度分层指标（浅/中/深分别统计）。

目前缺少 3D 真值中心线/graph 时，3D 指标需要谨慎：建议建立少量“3D 审计集”（例如从若干 stack 抽取少量 ROI 做人工 3D tracing），用作拓扑与方向评估的锚点。

## 6. 主要风险与缓解策略（组会/开题重点）

### 8-bit 量化风险

如果原始数据本可为 12/16-bit，压到 8-bit 会把深层低强度信号直接量化丢失，导致“不可逆漏检”。

缓解：保留 16-bit 母版用于训练/推理（即便最终展示转 8-bit），或至少保存每 stack 的强度直方图与量化映射以追溯。

### 遮挡导致不可观测

风险：模型输出再好，也可能系统性低估深层长度/密度。

缓解：在文档中明确“可观测性限制”；定量时增加深度分层置信度/缺失率报告；必要时仅在可观测深度范围内做结论。

### GT 口径漂移（Ranvier 断/连）

风险：评估不稳定，难以形成可复现结论。

缓解：并行两套协议（允许短 gap/不桥接），固定阈值与规则版本；把“生理定义”与“算法便利”区分写清。

### 标注稀缺导致泛化失败

缓解：自监督预训练 + 半监督扩标；严格按 stack 切分；用跨批次测试检验泛化。

### 内存与 IO 瓶颈（16GB 内存 + OME-TIFF 大文件）

缓解：patch 缓存、分块读取、断点续跑；必要时增加 OME-Zarr 作为训练缓存格式（不改变归档格式也可）。
